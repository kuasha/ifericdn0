function getCookie(e){var t="; "+document.cookie,o=t.split("; "+e+"=");return 2==o.length?o.pop().split(";").shift():void 0}function getUserName(e){var t=getCookie("user");if(t){t=t.replace(/\"/g,"");var o=JSON.parse(window.atob(t));return o.username||e}return e}function loggedIn(){var e=getCookie("usersecret");return!!e}function drawBarChart(e,t,o){if(o&&o.length>0){var i=t.width-t.margin.left-t.margin.right,n=t.height-t.margin.top-t.margin.bottom,a=o.map(function(e){return e[t.xAxisField]}),l=[0,d3.max(o,function(e){return e[t.yAxisField]})],r=d3.scale.ordinal().rangeBands([0,i],t.barSeparatorWidth),s=d3.scale.linear().range([n,0]),c=d3.svg.axis().scale(r).orient("bottom"),p=d3.svg.axis().scale(s).orient("left").ticks(t.tics,t.tics_modifier),u=d3.select(e).append("svg").attr("width",i+t.margin.left+t.margin.right).attr("height",n+t.margin.top+t.margin.bottom).append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")");r.domain(a),s.domain(l),u.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(c),u.append("g").attr("class","y axis").call(p).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(t.yAxisTitle),u.selectAll(".bar").data(o).enter().append("rect").attr("class","bar").attr("x",function(e){return r(e[t.xAxisField])}).attr("width",r.rangeBand()).attr("y",function(e){return s(e[t.yAxisField])}).attr("height",function(e){return n-s(e[t.yAxisField])})}}function drawLineChart(e,t,o){var i=t.width-t.margin.left-t.margin.right,n=t.height-t.margin.top-t.margin.bottom,a=d3.time.scale().range([0,i]),l=d3.scale.linear().range([n,0]),r=d3.svg.axis().scale(a).orient("bottom"),s=d3.svg.axis().scale(l).orient("left"),c=d3.svg.line().x(function(e){return a(e[t.xAxisField])}).y(function(e){return l(e[t.yAxisField])}),p=d3.select(e).append("svg").attr("width",i+t.margin.left+t.margin.right).attr("height",n+t.margin.top+t.margin.bottom).append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")");a.domain(d3.extent(o,function(e){return e[t.xAxisField]})),l.domain(d3.extent(o,function(e){return e[t.yAxisField]})),p.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(r),p.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(t.yAxisTitle),p.append("path").datum(o).attr("class","line").attr("d",c)}function drawPieChart(e,t,o){var i=Math.min(t.width,t.height)/2,n=d3.scale.ordinal().range(t.colors),a=d3.svg.arc().outerRadius(i-10).innerRadius(0),l=d3.layout.pie().sort(null).value(function(e){return e[t.valueFieldName]}),r=d3.select(e).append("svg").attr("width",t.width).attr("height",t.height).append("g").attr("transform","translate("+t.width/2+","+t.height/2+")"),s=r.selectAll(".arc").data(l(o)).enter().append("g").attr("class","arc");s.append("path").attr("d",a).style("fill",function(e){return n(e.data[t.groupFieldName])}),s.append("text").attr("transform",function(e){return"translate("+a.centroid(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return e.data[t.groupFieldName]})}var services;services=angular.module("cosmosUI.services",[]).value("version","0.1").factory("message",["$http",function(e){var t=[];return{push:function(e){t.push(e)},pop:function(){return t.shift()},hasMessage:function(){return t&&t.length>0}}}]).factory("globalhashtable",["$http","localStorageService",function(e,t){return{collections:t.get("globalhashtable")||{},getAll:function(){return this.collections},set:function(e,o){this.collections[e]=o,t.set("globalhashtable",this.collections)},get:function(e){return this.collections[e]}}}]).factory("namedcolection",["$http","localStorageService",function(e,t){return{collections:{},getCollection:function(e){var o=this.collections[e];return o||(o=t.get(e),o||(o=[]),this.collections[e]=o,t.set(e,o)),o},append:function(e,o){if(e&&o){var i=this.getCollection(e);i.push(o),t.set(e,i)}},removeById:function(e,o){var i=-1,n=this.getCollection(e);return n?(angular.forEach(n,function(e,t){0>i&&e._id===o&&(i=t)}),i>=0&&n.splice(i,1),t.set(e,n),i):i},length:function(e){var t=this.getCollection(e);return t?t.length:0}}}]).factory("calculator",["$http",function(e){return{sumColumnValues:function(e,t){var o=0;return angular.forEach(e,function(e,i){var n=Number(e[t]);n&&(o+=n)}),o},averageColumnValues:function(e,t){if(e.length<1)return 0;var o=sumColumnValues(e,t);o/e.length}}}]).factory("cosmos.cache",["$http",function(e){return{store:{},set:function(e,t){this.store[e]=t},get:function(e){return this.store[e]}}}]);var controllers=angular.module("cosmosUI.controllers",[]).controller("AdminMainCtrl",["$scope","$modal","CosmosService",function(e,t,o){e.userName=getUserName("No Name"),e.loggedIn=loggedIn}]).controller("MessageViewCtrl",["$scope","CosmosService","message",function(e,t,o){e.message=o.pop()}]).controller("ShowJsonDataCtrl",["$scope","$modalInstance","model",function(e,t,o){e.model=o,e.cancel=function(){t.dismiss("cancel")}}]).controller("SingleItemViewCtrl",["$scope","$routeParams",function(e,t){e.configId=t.configId,e.itemId=t.itemId}]).controller("AppListCtrl",["$scope","$routeParams","CosmosService","cosmos.cachedloader","cosmos.settings",function(e,t,o,i,n){e.apps=[],e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.init=function(){n.getApplications(function(t){t&&0!=t.length?e.apps=t:$location.path("/appstudio/")},e.processError)}}]);angular.module("cosmosUI.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]);var directives=angular.module("cosmosUI.directives",[]).directive("appVersion",["version",function(e){return function(t,o,i){o.text(e)}}]).directive("errorBanner",function(e){return{restrict:"E",template:'<div ng-show="hasError" class="bg-warning">    <button class="btn btn-xs btn-danger glyphicon glyphicon-remove pull-right" ng-click="clearError();"></button>    <div>        <label>Error code:</label>        <span ng-bind="status" />    </div>   <div ng-bind="status_data"></div></div>'}}).directive("page",["$compile",function(e){return{restrict:"E",scope:{pageId:"=pageid",appPath:"=?apppath"},controller:["$scope","$location","$routeParams","message","CosmosService","cosmos.settings",function(e,t,o,i,n,a){e.routeParams=o,e.getConfigurationByUrl=function(o){n.get(o,function(o){if(o.loginRequired&&!loggedIn()){var i=t.url();t.url("/login/?redirect="+i)}else e.pagedef=o},function(e,o){if(401==o){var i=t.url();t.url("/login/?redirect="+i)}})},e.getConfiguration=function(){e.pageId&&(e.appPath||(e.appPath=o.appPath),a.getAppSettings(e.appPath,"pageconfigobject",function(t){var o=a.getServiceRootUrl()+t+"/"+e.pageId+"/";e.getConfigurationByUrl(o)},function(t,o){var i=a.getServiceRootUrl()+"cosmos.pages/"+e.pageId+"/";e.getConfigurationByUrl(i)}))},e.getTemplate=function(){var e='    <div ng-repeat="field in pagedef.fields">\n        <field item="field"></field>\n    </div>\n{{page}}';return e}}],link:function(t,o,i){console.log("Creating page"),t.pagedef={};var n=t.getTemplate();if(n){t.getConfiguration();var a=angular.element(n);e(a)(t),o.replaceWith(a)}}}}]).directive("objectview",function(e){return{restrict:"E",scope:{itemId:"=",configId:"="},controller:["$scope","$location","$routeParams","message","CosmosService","cosmos.settings",function(e,t,o,i,n,a){e.routeParams=o,e.getPageConfigurationByUrl=function(o){n.get(o,function(o){if(o.loginRequired&&!loggedIn()){var i=t.url();t.url("/login/?redirect="+i)}else e.pagedef=o},function(e,o){if(401==o){var i=t.url();t.url("/login/?redirect="+i)}})},e.getPageConfiguration=function(){e.pageId&&(e.appPath=o.appPath,a.getAppSettings(e.appPath,"pageconfigobject",function(t){var o=a.getServiceRootUrl()+t+"/"+e.pageId+"/";e.getPageConfigurationByUrl(o)},function(t,o){var i=a.getServiceRootUrl()+"cosmos.pages/"+e.pageId+"/";e.getPageConfigurationByUrl(i)}))},e.getConfigurationByUrl=function(t){n.get(t,function(t){e.config=t,e.config.pageId?(e.pageId=e.config.pageId,e.getPageConfiguration()):e.config.pagedef&&(e.pagedef=e.config.pagedef),e.loadSingleItem()},function(e,t){})},e.getConfiguration=function(){e.appPath=o.appPath,a.getAppSettings(e.appPath,"singleitemconfigobject",function(t){var o=a.getServiceRootUrl()+t+"/"+e.configId+"/";e.getConfigurationByUrl(o)},function(t,o){var i=a.getServiceRootUrl()+"cosmos.singleitemconfig/"+e.configId+"/";e.getConfigurationByUrl(i)})},e.loadSingleItem=function(){var t=e.config.objectName,o=e.config.columns,i="";angular.forEach(o,function(e,t){i+=e.name+","});var l=a.getServiceRootUrl()+t+"/"+e.itemId+"/?columns="+i;n.get(l,function(t){e.data=t},function(e,t){})},e.getTemplate=function(){var e='    <div ng-repeat="field in pagedef.fields">\n        <field item="field" val="$parent.data"></field>\n    </div>\n';return e}}],link:function(t,o,i){console.log("Creating page"),t.pagedef={};var n=t.getTemplate();if(n){t.getConfiguration();var a=angular.element(n);o.replaceWith(a),e(a)(t)}}}}).directive("rawhtml",function(e){return{restrict:"E",scope:{htmlUrl:"="},controller:["$scope","$location","$routeParams","message","CosmosService","cosmos.settings",function(t,o,i,n,a,l){t.routeParams=i,t.getHtml=function(){var o=t.htmlUrl;a.get(o,function(o){t.htmlBlock=o;var i=angular.element(t.htmlBlock);t.element.replaceWith(i),e(i)(t)},function(e,t){})}}],link:function(e,t,o){console.log("Creating rawhtml element"),e.element=t,e.getHtml()}}}).directive("objectpicker",function(e){return{restrict:"E",scope:{endpoint:"=?",items:"=?",template:"=",detailtemplate:"=",placeholder:"="},require:"ngModel",controller:["$scope","$timeout","CosmosService",function(e,t,o){e.refreshData=function(t){if(e.endpoint){var i={q:t};o.search(e.endpoint,{params:i},function(t){e.items=t})}},e.getTemplate=function(){var t="";e.endpoint&&e.endpoint.length>0&&(t='refresh="refreshData($select.search)" refresh-delay="1000"');var o='                              <ui-select ng-model="selectedData.selected"                                         theme="bootstrap"                                          ng-disabled="disabled"                                          reset-search-input="false"                                          style="width: 300px;">                                 <ui-select-match placeholder="'+e.placeholder+'">'+e.template+'</ui-select-match>                                 <ui-select-choices repeat="data in items track by $index"                                          '+t+" >"+e.detailtemplate+"</ui-select-choices>                               </ui-select>";return o},e.startWatch=function(o){e.$watch("selectedData.selected",function(i,n){(i||n)&&t(function(){o.$setViewValue(i),e.$apply()})})}}],link:function(t,o,i,n){console.log("Creating objectpicker element"),t.element=o,t.items||(t.items=[]),t.selectedData={};var a=t.getTemplate(),l=angular.element(a);t.element.replaceWith(l),e(l)(t),t.startWatch(n)}}}).directive("filectrl",function(e){return{restrict:"E",scope:{label:"=",objectName:"=",val:"=",required:"="},controller:["$scope","$location","$routeParams","$modal","message","CosmosService","cosmos.settings",function(e,t,o,i,n,a,l){e.routeParams=o,e.browseFile=function(){var t=i.open({templateUrl:"lib/cosmos/partials/browsefile.html",controller:"BrowseFileController",size:"lg",backdrop:"static",resolve:{objectName:function(){return e.objectName}}});t.result.then(function(t){e.fileName="/gridfs/"+t.collection_name+"/"+t.file_id+" ["+t.filename+"]",e.selectedFile=t,e.val="/gridfs/"+t.collection_name+"/"+t.file_id},function(){})},e.getTemplate=function(){var e='<label>{{label}}<span ng-if="required">&nbsp;*&nbsp;</span></label><input readonly class="form-control" type="\'text\'" ng-model="val" title="{{fileName}}"/><button ng-click="browseFile()" class="btn btn-sm btn-primary">Brwose</button>';return e}}],link:function(t,o,i){var n=t.getTemplate();console.log("File ctrl template"+n);var a=angular.element(n);o.replaceWith(a),e(a)(t)}}}).directive("fileview",function(e){return{restrict:"E",scope:{label:"=",objectName:"=",ngModel:"=",required:"=",rootPath:"=?"},controller:["$scope","$location","$routeParams","$modal","message","CosmosService","cosmos.settings",function(e,t,o,i,n,a,l){e.routeParams=o,e.browseFile=function(){var t=i.open({templateUrl:"lib/cosmos/partials/browsefile.html",controller:"BrowseFileController",size:"lg",backdrop:"static",resolve:{objectName:function(){return e.objectName}}});t.result.then(function(t){e.fileName="/gridfs/"+t.collection_name+"/"+t.file_id+" ["+t.filename+"]",e.selectedFile=t,e.ngModel="/gridfs/"+t.collection_name+"/"+t.file_id},function(){})},e.getTemplate=function(){var e="<label>{{label}}<span ng-if=\"required\">&nbsp;*&nbsp;</span></label><iframe name='submit-iframe' id='submit-iframe' style='display: none;'></iframe>"+'<input readonly class="form-control" type="\'text\'" ng-model="ngModel" title="{{fileName}}"/><button ng-click="browseFile()" class="btn btn-sm btn-primary">Brwose</button>';return e}}],link:function(t,o,i){var n=t.getTemplate();console.log("File ctrl template"+n);var a=angular.element(n);o.replaceWith(a),e(a)(t)}}});controllers.controller("BrowseFileController",["$scope","$modalInstance","CosmosService","objectName",function(e,t,o,i){e.fileObjectName=i,e.uploaded_files=[],e.setAction=function(){document.uploadForm.action="/gridfs/"+e.fileObjectName+"/",e.getFiles()},e.selectFile=function(t){e.selectedFile=t},e.getFiles=function(){o.get("/gridfs/"+e.fileObjectName+"/",function(t){e.uploaded_files=t},function(t,o){e.processError(t,o)})},e.onFileUploadLoaded=function(){var t=this.contentDocument.body.innerText;if(t){var o=JSON.parse(JSON.parse(t)._d);angular.forEach(o,function(t,o){e.uploaded_files.push(t)}),e.$apply()}$("#submit-iframe").remove(),jQuery("#fileList").empty(),jQuery("#fileList").append(jQuery('<input class="file-selector" name="uploadedfile" type="file" onchange="angular.element(this).scope().fileNameChanged()" />'))},e.uploadFile=function(){jQuery("#iFramePlaceholder").html("<iframe name='submit-iframe' id='submit-iframe' style='display: none;'></iframe>"),jQuery("#submit-iframe").load(e.onFileUploadLoaded),document.getElementById("uploadForm").submit()},e.fileNameChanged=function(e){var t=!1;angular.forEach(jQuery("#fileList").children(),function(e,o){e.value||(t=!0)}),t||jQuery("#fileList").append(jQuery('<input class="file-selector" name="uploadedfile" type="file" onchange="angular.element(this).scope().fileNameChanged()" />'))},e.removeFile=function(t){var i=e.uploaded_files[t];if(confirm("Are you sure you want to delete the file "+i.filename+"?")){var n=i.file_id;o["delete"]("/gridfs/"+e.fileObjectName+"/"+n+"/",function(o){e.uploaded_files.splice(t,1)},function(t,o){e.processError(t,o)})}},e.ok=function(){t.close(e.selectedFile)},e.cancel=function(){t.dismiss("cancel")}}]),controllers.controller("LoginCtrl",["$scope","$routeParams","$location","CosmosService","$http",function(e,t,o,i,n){e.redirectUrl=t.redirect,e.haveAccount=!0,e.login=function(){return!e.username||e.username.length<2?void(e.error="Username is required."):!e.password||e.password.length<4?void(e.error="Password is required and must be at least 4 character long."):void n.post("/login/",{username:e.username,password:e.password}).success(function(t,i,n,a){o.url(e.redirectUrl||"/")}).error(function(t,o,i,n){401===o?e.error="Username or password did not match.":e.error=t})},e.signup=function(){if(!e.username||e.username.length<2)return void(e.error="Username is required.");if(!e.password||e.password.length<6)return void(e.error="Password is required and must be at least 6 character long.");if(e.password!==e.password_re)return void(e.error="Password does not match.");var t="/service/cosmos.users/",o={username:e.username,password:e.password};i.post(t,o,function(t){e.login()},function(t,o){409===o?e.error="Username already taken. Please use another username or login using your password.":e.error="Could not create user. Error code: "+o+" Error: "+t})}}]),controllers.controller("IndexCtrl",["$scope","$routeParams","$location","CosmosService","message","cosmos.cachedloader","cosmos.utils",function(e,t,o,i,n,a,l){e.pageRefs=[],e.appPath=t.appPath,e.processError=function(e,t){o.path("/appstudio/")},e.getConfiguration=function(){if(e.appPath&&e.appPath.length>0)e.getAppConfiguration();else{var t="/service/cosmos.globalsettings/";i.get(t,function(t){if(!t||1!=t.length)return void o.path("/appstudio/");var i=t[0];e.appId=i.defaultappid,e.getAppConfiguration()},function(t,o){e.processError(t,o)})}},e.getAppConfiguration=function(){var t;if(e.appId)t='/service/cosmos.applications/?filter={"id":"'+e.appId+'"}';else{if(!e.appPath)return void o.path("/applist/");t='/service/cosmos.applications/?filter={"path":"'+e.appPath+'"}'}var i="Application."+(e.appPath||e.appId);a.get(i,t,function(t){return t&&1==t.length?(e.appSettings=t[0],void(e.appPath?e.applySettings(e.appSettings):o.path("/a/"+e.appSettings.path+"/"))):void o.path("/appstudio/")},function(t,o){e.processError(t,o)})},e.applySettings=function(t){t?t.settings&&t.settings.indexPageId?e.pageRefs=[{type:"pageref",name:"Index",pageId:t.settings.indexPageId}]:l.getAllPages(t,function(t){e.pages=t},e.processError):e.processError(404,"Application not found at the path")},e.getConfiguration()}]),controllers.controller("TerminalCtrl",["$scope","$modal","$routeParams","CosmosService","cosmos.settings",function(e,t,o,i,n){e.service=n.getServiceRootUrl(),e.columns="",e.filter="",e.data="",e.result="",e.status="",e.status_data="",e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processResult=function(t){e.result=JSON.stringify(t,void 0,4)},e.clearResult=function(){e.hasError=!1,e.result="",e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.get=function(){e.clearResult();var t=e.service,o=!1;e.columns&&e.columns.length>0&&(t=t+"?columns="+e.columns,o=!0),e.filter&&e.filter.length>0&&(t=o?t+"&filter="+e.filter:t+"?filter="+e.filter),i.get(t,function(t){e.processResult(t)},function(t,o){e.processError(t,o)})},e.post=function(){e.clearResult();var t=e.service;i.post(t,e.data,function(t){e.processResult(t)},function(t,o){e.processError(t,o)})},e.put=function(){e.clearResult();var t=e.service;i.put(t,e.data,function(t){e.processResult(t)},function(t,o){e.processError(t,o)})},e["delete"]=function(){e.clearResult();var t=e.service;i["delete"](t,function(t){e.processResult(t)},function(t,o){e.processError(t,o)})}}]),controllers.controller("UsersCtrl",["$scope","$modal","CosmosService","cosmos.settings",function(e,t,o,i){e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.addUser=function(n,a){var l=t.open({templateUrl:"lib/cosmos/partials/adduser.html",controller:"UserModalInstanceCtrl",size:n,backdrop:"static",resolve:{user:function(){return a},roles:function(){return e.roles}}});l.result.then(function(t){if(t._id){var n=t._id;delete t._id,delete t.owner,delete t.username,delete t.createtime,t.password||delete t.password,o.put(i.getServiceRootUrl()+"cosmos.users/"+n+"/",t,function(t){e.getUsers()},function(t,o){e.processError(t,o)})}else o.post(i.getServiceRootUrl()+"cosmos.users/",t,function(t){e.getUsers()},function(t,o){e.processError(t,o)})},function(){})},e.editUser=function(t){e.addUser("lg",e.users[t])},e.removeUser=function(t){var n=e.users[t];if(confirm("Are you sure you want to delete the user "+n.username+"?")){var a=n._id;o["delete"](i.getServiceRootUrl()+"cosmos.users/"+a+"/",function(t){e.getUsers()},function(t,o){e.processError(t,o)})}},e.getRoles=function(){o.get(i.getServiceRootUrl()+"cosmos.rbac.object.role/",function(t){e.roles=t},function(t,o){e.processError(t,o)})},e.getRoles(),e.getUsers=function(){o.get(i.getServiceRootUrl()+"cosmos.users/",function(t){e.users=t},function(t,o){e.processError(t,o)})},e.getUsers()}]),controllers.controller("UserModalInstanceCtrl",["$scope","$modalInstance","roles","user",function(e,t,o,i){e.user=i||{username:null,password:null,password_re:null,email:null,roles:[]},e.user.password=null,e.isUpdating=i&&i._id&&i._id.length>0,e.roles=o,e.getRoleName=function(t){var o="[Builtin Role]";return angular.forEach(e.roles,function(e,i){e.sid===t&&(o=e.name)}),o},e.ok=function(){e.user.username&&(e.user.password||e.isUpdating)&&e.user.password==e.user.password_re?(delete e.user.password_re,t.close(e.user)):e.haserror=!0},e.removeRole=function(t){e.user.roles.splice(t,1)},e.addRole=function(t){if(t&&!(t.length<1)){e.user.roles||(e.user.roles=[]);var o=!1;angular.forEach(e.user.roles,function(e,i){e===t&&(o=!0)}),o||e.user.roles.push(t)}},e.cancel=function(){t.dismiss("cancel")}}]),controllers.controller("RolesCtrl",["$scope","$modal","CosmosService","cosmos.settings",function(e,t,o,i){e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.addRole=function(n,a){var l=t.open({templateUrl:"lib/cosmos/partials/addrole.html",controller:"RoleModalInstanceCtrl",size:n,backdrop:"static",resolve:{role:function(){return a}}});l.result.then(function(t){if(e.current_role=t,t._id){var n=t._id;delete t._id,delete t.sid,o.put(i.getServiceRootUrl()+"cosmos.rbac.object.role/"+n+"/",t,function(t){e.getRoles()},function(t,o){e.processError(t,o)})}else o.post(i.getServiceRootUrl()+"cosmos.rbac.object.role/",t,function(t){console.log(t),e.getRoles()},function(t,o){e.processError(t,o)})},function(){})},e.editRole=function(t){e.addRole("lg",e.roles[t])},e.removeRole=function(t){var n=e.roles[t];if(confirm("Are you sure you want to delete the role "+n.name+"?")){var a=n._id;o["delete"](i.getServiceRootUrl()+"cosmos.rbac.object.role/"+a+"/",function(t){e.getRoles()},function(t,o){e.processError(t,o)})}},e.getRoles=function(){o.get(i.getServiceRootUrl()+"cosmos.rbac.object.role/",function(t){e.roles=t},function(t,o){e.processError(t,o)})},e.getRoles()}]),controllers.controller("RoleModalInstanceCtrl",["$scope","$modalInstance","role",function(e,t,o){e.role={name:null,role_items:[]},e.access_types=[{name:"access",display:"Role access"},{name:"owner_access",display:"Owner access"}],e.populate=function(t){t&&(e.isUpdating=t._id&&t._id.length>0,e.role._id=t._id,e.role.name=t.name,e.role.sid=t.sid,angular.forEach(t.role_items,function(t,o){if(t.access_bits=[],t.access&&t.access.length>0){var i=jQuery.inArray("READ",t.access)>-1,n=jQuery.inArray("INSERT",t.access)>-1,a=jQuery.inArray("WRITE",t.access)>-1,l=jQuery.inArray("DELETE",t.access)>-1;t.access_bits.read=i,t.access_bits.insert=n,t.access_bits.write=a,t.access_bits["delete"]=l,t.type=e.access_types[0].name}else if(t.owner_access&&t.owner_access.length>0){var i=jQuery.inArray("READ",t.owner_access)>-1,n=jQuery.inArray("INSERT",t.owner_access)>-1,a=jQuery.inArray("WRITE",t.owner_access)>-1,l=jQuery.inArray("DELETE",t.owner_access)>-1;t.access_bits.read=i,t.access_bits.insert=n,t.access_bits.write=a,t.access_bits["delete"]=l,t.type=e.access_types[1].name}e.role.role_items.push(t)}))},e.addRoleItem=function(){e.role.role_items.push({})},e.removeRoleItem=function(t){e.role.role_items.splice(t,1)},e.ok=function(){if(e.role.name&&e.role.role_items.length>0){var o=!1,i={name:e.role.name,type:"object.Role"};e.role.sid&&(i.sid=e.role.sid),i._id=e.role._id,i.role_items=[],angular.forEach(e.role.role_items,function(e,t){var o={object_name:e.object_name,property_name:e.property_name,type:"object.RoleItem"};o[e.type]=[],e.access_bits.read&&o[e.type].push("READ"),e.access_bits.insert&&o[e.type].push("INSERT"),e.access_bits.write&&o[e.type].push("WRITE"),e.access_bits["delete"]&&o[e.type].push("DELETE"),i.role_items.push(o)}),o||t.close(i)}else e.haserror=!0},e.cancel=function(){t.dismiss("cancel")},e.populate(o)}]),controllers.controller("ListCtrl",["$scope","$routeParams","$modal","CosmosService",function(e,t,o,i){e.serviceName="lists",e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.getData=function(){var t="/service/cosmos.listconfigurations/";i.get(t,function(t){e.lists=t},function(t,o){e.processError(t,o)})},e.getData()}]),controllers.controller("ListDetailCtrl",["$scope","$routeParams","$templateCache","$modal","CosmosService",function(e,t,o,i,n){e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.listId=t.listId,e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.getConfiguration=function(){var t="/service/cosmos.listconfigurations/"+e.listId+"/";n.get(t,function(t){e.listConfiguration=t,e.getData()},function(t,o){e.processError(t,o)})},e.getData=function(){var t="";angular.forEach(e.listConfiguration.columns,function(e,o){t+=e.name+","});var o="/service/"+e.listConfiguration.objectName+"/?columns="+t;n.get(o,function(t){e.data=t},function(t,o){e.processError(t,o)})},e.showListItemDetails=function(t,o){e.showDetails("lg",t,o)},e.showDetails=function(e,t,o){if(o.allowDetails){i.open({templateUrl:"partials/show_json.html",controller:"ShowJsonDataCtrl",size:e,backdrop:"static",resolve:{model:function(){return t}}})}},e.getConfiguration()}]),controllers.controller("FileUploadCtrl",["$scope","$modal","$routeParams","CosmosService",function(e,t,o,i){e.fileObjectName=o.fileObjectName,e.setAction=function(){document.uploadForm.action="/gridfs/"+e.fileObjectName+"/"},e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.uploaded_files=[{file_id:"test"}],e.onFileUploadLoaded=function(){var t=this.contentDocument.body.innerText;if(t){var o=JSON.parse(JSON.parse(t)._d);angular.forEach(o,function(t,o){e.uploaded_files.push(t)}),e.$apply()}$("#submit-iframe").remove(),jQuery("#fileList").empty(),jQuery("#fileList").append(jQuery('<input class="file-selector" name="uploadedfile" type="file" onchange="angular.element(this).scope().fileNameChanged()" />'))},e.uploadFile=function(){jQuery("#iFramePlaceholder").html("<iframe name='submit-iframe' id='submit-iframe' style='display: none;'></iframe>"),jQuery("#submit-iframe").load(e.onFileUploadLoaded),document.getElementById("uploadForm").submit()},e.fileNameChanged=function(e){var t=!1;angular.forEach(jQuery("#fileList").children(),function(e,o){e.value||(t=!0)}),t||jQuery("#fileList").append(jQuery('<input class="file-selector" name="uploadedfile" type="file" onchange="angular.element(this).scope().fileNameChanged()" />'))},e.removeFile=function(t){var o=e.uploaded_files[t];if(confirm("Are you sure you want to delete the file "+o.filename+"?")){var n=o.file_id;i["delete"]("/gridfs/"+e.fileObjectName+"/"+n+"/",function(o){e.uploaded_files.splice(t,1)},function(t,o){e.processError(t,o)})}},e.getFiles=function(){i.get("/gridfs/"+e.fileObjectName+"/",function(t){e.uploaded_files=t},function(t,o){e.processError(t,o)})},e.getFiles()}]),controllers.controller("FormDesignController",["$scope","$routeParams","$templateCache","$modal","CosmosService","cosmos.settings",function(e,t,o,i,n,a){e.designMode=!0,e.activeTab="tools",e.onsuccess_types=[{name:"message",title:"Message"},{name:"url",title:"Redirect"}],e.selectItem=function(t){e.selectedItem=t,e.activeTab="settings";var o=e.optionFormByType[t.type];o?e.optionsform=o:e.optionsform=e.optionFormByType["default"]},e.optionsform={},e.optionFormByType={input:{fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{type:"checkbox",label:"Required",name:"required"},{htmltype:"text",type:"input",label:"Min Length",name:"minlength"},{htmltype:"text",type:"input",label:"Max Length",name:"maxlength"},{htmltype:"text",type:"input",label:"Pattern",name:"pattern"},{htmltype:"text",type:"input",label:"Placeholder",name:"placeholder"},{htmltype:"text",type:"input",label:"Tooltip",name:"title"},{label:"Type",type:"select",options:{choices:[{value:"text",label:"Text"},{value:"password",label:"Password"},{value:"button",label:"Button"},{value:"checkbox",label:"Check box"},{value:"color",label:"Color"},{value:"date",label:"Date"},{value:"datetime",label:"Date time"},{value:"datetime-local",label:"Local datetime"},{value:"email",label:"Email"},{value:"file",label:"File"},{value:"hidden",label:"Hidden"},{value:"image",label:"Image"},{value:"month",label:"Month"},{value:"number",label:"Number"},{value:"radio",label:"Radio"},{value:"range",label:"Range"},{value:"reset",label:"Reset"},{value:"search",label:"Search"},{value:"submit",label:"Submit"},{value:"tel",label:"Telephone"},{value:"time",label:"Time"},{value:"url",label:"URL"},{value:"week",label:"Week"}]},name:"htmltype",nullable:!1}]},form:{fields:[{htmltype:"text",type:"input",label:"Title",name:"title"},{htmltype:"text",type:"input",label:"Name",name:"name"},{htmltype:"text",type:"input",label:"Action",name:"action"},{type:"checkbox",label:"Enable reCapcha",name:"enableReCapcha"},{type:"composite",label:"On success",name:"onsuccess",fields:[{label:"Type",type:"select",options:{choices:[{value:"message",label:"Message"},{value:"inlinemessage",label:"Embeded message"},{value:"url",label:"Redirect"}]},name:"type",nullable:!1},{htmltype:"text",type:"input",label:"Value",name:"value"}]}]},select:{label:"Select Options",type:"composite",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{label:"Options",type:"composite",options:{},fields:[{label:"Choices",type:"array",options:{},fields:[{label:"Label",htmltype:"text",type:"input",name:"label"},{label:"Value",htmltype:"text",type:"input",name:"value"}],name:"choices"}],name:"options"}]},array:{label:"Select Options",type:"composite",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{label:"Options",type:"composite",options:{},fields:[{label:"Value only",type:"checkbox",name:"primitive"}],name:"options"}]},lookup:{label:"Select Options",type:"composite",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{label:"Options",type:"composite",options:{},fields:[{label:"Value only",type:"checkbox",name:"saveValueOnly"},{label:"Hide reference",type:"checkbox",name:"hideRefType"},{label:"References",type:"array",name:"lookups",fields:[{label:"Data endpoint",htmltype:"text",type:"input",name:"url"},{label:"Reference label",htmltype:"text",type:"input",name:"lookupname"},{label:"Reference name",htmltype:"text",type:"input",name:"ref"},{label:"Value field",htmltype:"text",type:"input",name:"value"},{label:"Label field",htmltype:"text",type:"input",name:"label"}]}],name:"options"}]},radiogroup:{label:"Select Options",type:"form",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{label:"Options",type:"composite",options:{},fields:[{label:"Choices",type:"array",options:{},fields:[{label:"Label",htmltype:"text",type:"input",name:"label"},{label:"Value",htmltype:"text",type:"input",name:"value"}],name:"choices"}],name:"options"}]},filectrl:{label:"File Select Options",type:"form",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{htmltype:"text",type:"input",label:"Object name",name:"objectName"}]},condition:{label:"Condition options",type:"condition",name:"condition",fields:[{htmltype:"text",type:"input",label:"Label",name:"label"},{htmltype:"text",type:"input",label:"Name",name:"name"},{htmltype:"text",type:"input",label:"Expression",name:"expression"}]},"default":{fields:[{htmltype:"text",type:"input",label:"Label",name:"label"
},{htmltype:"text",type:"input",label:"Name",name:"name"}]}},e.toolsList=[{label:"Input",type:"input"},{label:"Static",type:"static",options:{value:""}},{label:"Text Area",type:"textarea",options:{}},{label:"Code editor",type:"codeeditor",options:{}},{label:"Select",type:"select",options:{choices:[{value:"option1",label:"option1"},{value:"option2",label:"option2"}]}},{label:"Checkbox",type:"checkbox",options:{}},{label:"Options",type:"radiogroup",options:{choices:[{value:"option1",label:"option1"},{value:"option2",label:"option2"}]}},{label:"File select",type:"filectrl"},{label:"Group",type:"composite",options:{},fields:[]},{label:"Array",type:"array",options:{},fields:[]},{label:"Lookup",type:"lookup",options:{},fields:[]},{label:"Condition",type:"condition",fields:[],elsefields:[]}],e.components=jQuery.extend(!0,[],e.toolsList),e.form={title:"Untitled form",type:"form",onsuccess:{type:"message",value:"Thank you"},fields:[]},e.formId=t.formId,e.appPath=t.appPath,e.itemConfigName="formconfigobject",e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.processForm=function(t){t.onsuccess||(t.onsuccess={}),e.form=t},e.getConfiguration=function(){if(e.formId){var t=e.appPath;a.getAppSettings(t,e.itemConfigName,function(t){var o="/service/"+t+"/"+e.formId+"/";n.get(o,function(t){e.processForm(t)},function(t,o){e.processError(t,o)})},function(t,o){e.processError(t,o)})}else e.form={title:"Test form",type:"form",fields:[]}},e.sortingLog=[],e.sortableOptions={connectWith:".apps-container",placeholder:"beingDragged",stop:function(t,o){$(t.target).hasClass("first")&&o.item.sortable.droptarget&&t.target!=o.item.sortable.droptarget[0]&&(e.components=jQuery.extend(!0,[],e.toolsList))},update:function(t,o){var i=o.item.scope();i&&e.selectItem(i.comp)}},e.sortableToolsOptions=e.sortableOptions,e.getView=function(e){return e?"form"==e.type?"composite-field.html":e.type+"-field.html":null},e.removeItem=function(e,t){e.splice(t,1)},e.insertItem=function(e,t,o){e.splice(t,0,o)},e.selectTab=function(t){e.activeTab=t},e.saveForm=function(){e.clearError(),e.result=null;var t=e.form._id,o=e.appPath;a.getAppSettings(o,e.itemConfigName,function(o){var i="/service/"+o+"/";t?(i+=t,n.put(i,e.form,function(t){e.result=t,$.notify("Form updated","success")},function(t,o){e.processError(t,o)})):n.post(i,e.form,function(t){e.result=t,e.form._id=JSON.parse(t),$.notify("Form saved","success")},function(t,o){e.processError(t,o)})},function(t,o){e.processError(t,o)})},e.getConfiguration()}]),controllers.controller("PageDesignCtrl",["$scope","$routeParams","$templateCache","$modal","CosmosService","cosmos.settings","globalhashtable",function(e,t,o,i,n,a,l){e.hashtable=l,e.cosmosCurrentApplicationRef="_Cosmos_Current_Application_",e.designMode=!0,e.activeTab="tools",e.selectedApplication=void 0,e.onsuccess_types=[{name:"message",title:"Message"},{name:"url",label:"Redirect"}],e.init=function(){$("#toolbar").dialog({position:{my:"left-200 top",at:"left-200 top",of:""},closeText:"x"})},e.initSettings=function(){$("#settings").dialog({position:{my:"right-200 top",at:"right-200 top",of:""},closeText:"x"})},e.selectItem=function(t){e.selectedItem=t,e.activeTab="settings";var o=e.optionFormByType[t.type];o?e.optionsform=o:e.optionsform=e.optionFormByType["default"]},e.toolsActive=function(){return"tools"===e.activeTab},e.settingsActive=function(){return"settings"===e.activeTab},e.optionsform={},e.optionFormByType={page:{fields:[{type:"input",name:"title",label:"Title"},{type:"checkbox",name:"loginRequired",label:"Login required"}]},menuref:{fields:[{type:"composite",label:"Settings",name:"value",fields:[{type:"input",label:"Menu Id",name:"menuId"}]}]},formref:{fields:[{type:"composite",label:"Settings",name:"value",fields:[{type:"input",label:"Form Id",name:"formId"}]}]},listref:{fields:[{type:"composite",label:"Settings",name:"value",fields:[{type:"input",label:"List Id",name:"listId"}]}]},chartref:{fields:[{type:"composite",label:"Settings",name:"value",fields:[{type:"input",label:"Chart Id",name:"chartId"}]}]},cssref:{fields:[{type:"input",label:"href",name:"href"}]},jsref:{fields:[{type:"input",label:"src",name:"src"}]},extjsref:{fields:[{type:"input",label:"src",name:"src"}]},widgethost:{fields:[{type:"input",label:"Widget Name",name:"value"}]},condition:{label:"Condition options",type:"condition",name:"condition",fields:[{type:"input",label:"Label",name:"label"},{type:"input",label:"Name",name:"name"},{type:"input",label:"Expression",name:"expression"}]},htmlblock:{fields:[{label:"Type",name:"blocktype",type:"select",options:{choices:[{value:"h1",label:"h1"},{value:"h2",label:"h2"},{value:"h3",label:"h3"},{value:"h4",label:"h4"},{value:"h5",label:"h5"},{value:"p",label:"p"}]}},{type:"codeeditor",label:"Html",name:"value"}]},"default":{fields:[{type:"input",label:"Label",name:"label"},{type:"input",label:"Name",name:"name"}]}},e.toolsList=[{label:"Menu",type:"menuref"},{label:"Form",type:"formref",options:{value:""}},{label:"Page",type:"pageref",options:{}},{label:"List",type:"listref",options:{}},{label:"Html",type:"htmlblock",options:{}},{label:"2 Columns",type:"twocolumn"},{label:"3 Columns",type:"threecolumn"},{label:"Chart",type:"chartref"},{label:"Widget",type:"widgethost"},{label:"CSS File",type:"cssref"},{label:"JS File",type:"jsref"},{label:"External JS File",type:"extjsref"}],e.components=jQuery.extend(!0,[],e.toolsList),e.page={title:"Untitled page",type:"page",onsuccess:{type:"message",value:"Thank you"},fields:[]},e.pageId=t.pageId,e.appPath=t.appPath,e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.processPage=function(t){t.onsuccess||(t.onsuccess={}),t.type||(t.type="page"),e.page=t},e.getConfigurationByUrl=function(t){n.get(t,function(t){e.processPage(t)},function(t,o){e.processError(t,o)})},e.getPageConfiguration=function(){if((e.appPath||e.selectedApplication)&&e.pageId){var t=e.appPath||e.selectedApplication.path;a.getAppSettings(t,"pageconfigobject",function(t){var o="/service/"+t+"/"+e.pageId+"/";e.getConfigurationByUrl(o)},function(t,o){var i="/service/cosmos.pages/"+e.pageId+"/";e.getConfigurationByUrl(i)})}else e.page||(e.page={title:"Test page",type:"page",fields:[]})},e.getConfiguration=function(){e.getPageConfiguration()},e.sortingLog=[],e.sortableOptions={connectWith:".apps-container",placeholder:"beingDragged",stop:function(t,o){$(t.target).hasClass("first")&&o.item.sortable.droptarget&&t.target!=o.item.sortable.droptarget[0]&&(e.components=jQuery.extend(!0,[],e.toolsList))},update:function(t,o){var i=o.item.scope();i&&e.selectItem(i.comp)}},e.sortableToolsOptions=e.sortableOptions,e.removeItem=function(e,t){e.splice(t,1)},e.insertItem=function(e,t,o){e.splice(t,0,o)},e.selectTab=function(t){e.activeTab=t},e.savePageWithUrl=function(t){e.clearError(),e.result=null;var o=e.page._id;o?(t=t+o+"/",n.put(t,e.page,function(t){e.result=t,$.notify("Page updated","success")},function(t,o){e.processError(t,o)})):n.post(t,e.page,function(t){e.result=t,e.page._id=JSON.parse(t),$.notify("Page saved","success")},function(t,o){e.processError(t,o)})},e.savePage=function(){a.getAppSettings(e.appPath,"pageconfigobject",function(t){var o="/service/"+t+"/";e.savePageWithUrl(o)},function(t,o){var i="/service/cosmos.pages/";e.savePageWithUrl(i)})},e.init=function(){e.getConfiguration()}}]),controllers.controller("FormViewCtrl",["$scope","$routeParams","$location","$injector","CosmosService","message",function(e,t,o,i,n,a){e.form={},e.data={},e.formref={type:"formref",value:{formId:t.formId}},e.dataId=t.dataId}]),controllers.controller("FormViewModalCtrl",["$scope","$routeParams","$location","$injector","CosmosService","message","model","formId",function(e,t,o,i,n,a,l,r){e.formref={type:"formref",value:{formId:r||t.formId}},e.dataId=l?l._id:t.dataId}]),controllers.controller("PageViewCtrl",["$scope","$routeParams","$location","CosmosService","cosmos.settings",function(e,t,o,i,n){e.pageId=t.pageId,e.appPath=t.appPath,e.routeParams=t,e.getConfigurationByUrl=function(t){i.get(t,function(t){if(t.loginRequired&&!loggedIn()){var i=o.url();o.url("/login/?redirect="+i)}else e.page=t},function(e,t){})},e.getConfiguration=function(){n.getAppSettings(e.appPath,"pageconfigobject",function(t){var o=n.getServiceRootUrl()+t+"/"+e.pageId+"/";e.getConfigurationByUrl(o)},function(t,o){var i=n.getServiceRootUrl()+"cosmos.pages/"+e.pageId+"/";e.getConfigurationByUrl(i)})},e.init=function(){n.initSettings(function(){e.getConfiguration()})},e.init()}]),controllers.controller("AppStudioCtrl",["$scope","$routeParams","$templateCache","$modal","CosmosService","cosmos.settings","globalhashtable","cosmos.utils",function(e,t,o,i,n,a,l,r){e.selectedApplication=void 0,e.appPath=t.appPath,e.hashtable=l,e.globalSettings={},e.cosmosCurrentApplicationRef="_Cosmos_Current_Application_",e.applicationChanged=function(){},e.getGlobalSettings=function(){a.getGlobalSettings(function(t){e.globalSettings=t},e.processError)},e.getApplications=function(){a.getApplications(function(t){e.applications=t},e.processError)},e.processError=function(t,o){e.hasError=!0,e.status=o,e.status_data=JSON.stringify(t)},e.clearError=function(){e.hasError=!1,e.status="",e.status_data=""},e.processItem=function(t,o){var i=e.selectedApplication;i[t]=o,e.hashtable.set(e.cosmosCurrentApplicationRef,i)},e.getItemsByUrl=function(t,o){n.get(o,function(o){e.processItem(t,o)},function(t,o){e.processError(t,o)})},e.getItems=function(t,o,i){if(i&&i.path){var n=i.path;a.getAppSettings(n,o,function(n){var a="/service/"+n+"/";"widgetobject"!==o&&"sourcecolname"!==o&&"interceptorconigobject"!==o&&"appendpointconigobject"!==o||(a=a+'?filter={"app_id":"'+i.id+'"}'),e.getItemsByUrl(t,a)},function(t,o){e.processError(t,o)})}},e.loadAppItems=function(t){t&&(e.getItems("pages","pageconfigobject",t),e.getItems("forms","formconfigobject",t),e.getItems("lists","listconfigobject",t),e.getItems("charts","chartconfigobject",t),e.getItems("widgets","widgetobject",t),e.getItems("menus","menuconfigobject",t),e.getItems("singleitemviews","singleitemconfigobject",t),e.getItems("sourcefiles","sourcecolname",t),e.getItems("interceptors","interceptorconigobject",t),e.getItems("appendpoints","appendpointconigobject",t))},e.loadAppItemsForSelectedApp=function(){e.selectedApplication&&e.loadAppItems(e.selectedApplication)},e.setAsDefault=function(t){t&&t.id&&r.setAppAsDefault(t,function(){e.globalSettings.defaultappid=t.id})},e.setPageAsDefault=function(t){var o=e.selectedApplication;o&&o._id&&t&&t._id&&r.setPageAsDefault(o,t,function(){e.selectedApplication.settings.indexPageId=t._id},e.processItem)},e.openApp=function(t){t&&(e.selectedApplication=t),e.selectedApplication?(e.loadAppItems(e.selectedApplication),e.hashtable.set(e.cosmosCurrentApplicationRef,e.selectedApplication)):e.hashtable.set(e.cosmosCurrentApplicationRef,void 0)},e.deleteItem=function(t,o,i,l,r,s){if(t||(t=e.selectedApplication),confirm("Are you sure you want to delete the "+o+" "+i+"?")){var c=t.path;a.getAppSettings(c,l,function(t){var o="/service/"+t+"/"+r+"/";n["delete"](o,function(t){s?s(t):e.loadAppItemsForSelectedApp()},function(t,o){e.processError(t,o)})},e.processError)}},e.deleteApp=function(t){e.deleteItem(t,"app",t.title,"appconfigobject",t._id,function(t){a.clearCache(a.getAllAppCacheName()),e.getApplications()})},e.deleteSourceFile=function(t){var o="/gridfs/cosmos.sourcefiles/"+t.file_id+"/";e.deleteItem(app,"source file",t.filename,"sourcecolname",t._id,function(t){a.clearCache(a.getAllAppCacheName()),n["delete"](o,function(e){},function(t,o){e.processError(t,o)}),e.loadAppItemsForSelectedApp()})},e.closeApp=function(){e.hashtable.set(e.cosmosCurrentApplicationRef,void 0)},e.getCurrentApplicationTitle=function(){var t=e.hashtable.get(e.cosmosCurrentApplicationRef);return t?t.title:void 0},e.isAppOpened=function(){var t=e.hashtable.get(e.cosmosCurrentApplicationRef);return!!t},e.getOpenedApp=function(){return e.hashtable.get(e.cosmosCurrentApplicationRef)},e.init=function(){e.getGlobalSettings(),e.getApplications(),e.selectedApplication=e.getOpenedApp(),e.applicationChanged()}}]),controllers.controller("ItemDesignCtrl",["$scope","$routeParams","$templateCache","$modal","CosmosService","cosmos.settings","globalhashtable",function(e,t,o,i,n,a,l){e.initForms=function(){e.widgetEditorForm={name:"widgetEditor",title:"Widget editor",fields:[{type:"input",name:"name",label:"Name"},{label:"Template",type:"codeeditor",name:"template"}],type:"form"};var t=e.getItemConfigName("widget"),o=a.getAppSettingsByApp(e.app,t),i="/service/"+o+"?columns=name";e.listEditorForm={name:"listconfiguration",title:"List configuration",type:"form",fields:[{type:"input",name:"title",label:"Title"},{type:"input",name:"objectName",label:"Object name"},{type:"checkbox",name:"allowUserFilter",label:"Allow user modifiable server filter"},{type:"checkbox",name:"allowClientFilter",label:"Allow search on client"},{type:"input",name:"filter",label:"Filter"},{type:"checkbox",name:"useQueryFilterParam",options:{},label:"Accept query parameter as filter"},{type:"lookup",options:{saveValueOnly:!0,lookups:[{url:i,ref:"widget",lookupname:"Template",value:"name",label:"name"}],hideRefType:!0},name:"widgetName",label:"List Widget"},{fields:[{type:"input",name:"title",label:"Title"},{type:"input",name:"name",label:"Name"},{type:"lookup",options:{saveValueOnly:!0,lookups:[{url:i,ref:"widget",lookupname:"Template",value:"name",label:"name"}],hideRefType:!0},name:"widget",label:"Widget"},{type:"checkbox",options:{},name:"showInList",label:"Show in list"}],type:"array",options:{},name:"columns",label:"Columns"}]},e.menuEditorForm={name:"menueditor",title:"Menu editor",fields:[{label:"Brand title",type:"input",name:"brandtitle",htmltype:"text"},{label:"Brand link",type:"input",name:"brandhref",htmltype:"text"},{label:"Type",type:"select",name:"navtype",options:{choices:[{value:"topfixed",label:"Top fixed"},{value:"sidebar",label:"Side bar"}]}},{fields:[{label:"Type",type:"select",options:{choices:[{value:"menuitem",label:"Link"},{value:"inlinewidget",label:"Inline widget"}]},name:"type"},{name:"value",label:"Set value",fields:[{label:"Widget text",type:"codeeditor",name:"widgettext",htmltype:"text"}],elsefields:[{label:"Label",type:"input",name:"label",htmltype:"text"},{label:"Link",type:"input",name:"href",htmltype:"text"}],type:"condition",expression:"$parent.d.type === 'inlinewidget'"},{label:"CSS Class",type:"input",name:"cssclass",htmltype:"text"}],label:"Menu items",type:"array",options:{},name:"fields"}],type:"form"},e.singleitemconfigEditorForm={name:"singleitemviewform",title:"Single item view",type:"form",fields:[{label:"Page Id",type:"input",name:"pageId",htmltype:"text"},{label:"Object name",type:"input",name:"objectName",htmltype:"text"},{fields:[{label:"Name",type:"input",name:"name",htmltype:"text"}],label:"Columns",type:"array",options:{},name:"columns"}]},e.chartconfigEditorForm={name:"chartConfigForm",title:"Chart Editor",fields:[{type:"input",name:"title",label:"Title"},{type:"input",name:"objectName",label:"Object name",required:!0},{type:"input",name:"filter",label:"Filter"},{type:"checkbox",options:{},name:"useQueryFilterParam",label:"Accept query parameter as filter"},{fields:[{type:"input",name:"name",required:!0,label:"Name"}],type:"array",options:{},name:"columns",label:"Columns"},{label:"Chart type",type:"select",options:{choices:[{value:"bar",label:"Bar"},{value:"line",label:"Line"},{value:"pie",label:"Pie"}]},name:"chartType",required:!0,htmltype:"text"},{name:"piecomponents",fields:[{type:"input",name:"valueFieldName",required:!0,label:"Value field name"},{type:"input",name:"groupFieldName",required:!0,label:"Group field name"}],label:"Pie Chart components",elsefields:[],type:"condition",expression:"$parent.$parent.val.chartType === 'pie'"},{name:"barlinechartcomp",fields:[{label:"X Axis Field",type:"input",name:"xAxisField",required:!0,htmltype:"text"},{label:"Y Axis Field",type:"input",name:"yAxisField",required:!0,htmltype:"text"},{label:"Y Axis Title",type:"input",name:"yAxisTitle",required:!0,htmltype:"text"}],label:"Bar/Line chart components",elsefields:[],type:"condition",expression:"$parent.$parent.val.chartType === 'bar' || $parent.$parent.val.chartType === 'line'"},{name:"barcomp",fields:[{label:"Tics",type:"input",name:"tics",required:!0,htmltype:"text"},{label:"Tics modifier",type:"input",name:"tics_modifier",htmltype:"text"},{label:"Bar separator width",type:"input",name:"barSeparatorWidth",htmltype:"text"}],label:"Bar chart components",elsefields:[],type:"condition",expression:"$parent.$parent.val.chartType === 'bar'"},{label:"Chart width",type:"input",name:"width",required:!0,htmltype:"text"},{label:"Chart height",type:"input",name:"height",required:!0,htmltype:"text"},{fields:[{label:"Top",type:"input",name:"top",htmltype:"text"},{label:"Left",type:"input",name:"left",htmltype:"text"},{label:"Right",type:"input",name:"right",htmltype:"text"},{label:"Bottom",type:"input",name:"bottom",htmltype:"text"}],type:"composite",name:"margin",label:"Margin"}],onsuccess:{},type:"form"},e.interceptorEditorForm={title:"Edit interceptor",name:"interceptorEditor",type:"form",fields:[{label:"Object name",type:"input",name:"object_name",required:!0,htmltype:"text"},{label:"Module name",type:"input",name:"interceptor_module",required:!0,htmltype:"text"},{label:"Function name",type:"input",name:"interceptor_name",required:!0,htmltype:"text"},{label:"Interceptor type",type:"radiogroup",options:{choices:[{value:0,label:"Pre-processor",name:"preprocessor"},{value:1,label:"Post-processor",name:"postprocessor"}]},name:"interceptor_type"},{label:"For access type",type:"array",name:"access",options:{primitive:!0},fields:[{label:"Access type",type:"select",options:{choices:[{value:"INSERT",label:"Insert"},{value:"READ",label:"Read"},{value:"WRITE",label:"Write"},{value:"DELETE",label:"Delete"},{value:"SEARCH",label:"Search"}]},name:"access_name"}]}]},e.appendpointEditorForm={title:"Edit endpoint",name:"appendpointEditor",type:"form",fields:[{label:"URI Pattern",type:"input",name:"uri_pattern",required:!0,htmltype:"text"},{label:"Handler module",type:"input",name:"handler_module",required:!0,htmltype:"text"},{label:"Handler name",type:"input",name:"handler_name",required:!0,htmltype:"text"}]},e.appEditorForm={name:"application",title:"Application",fields:[{label:"Id",type:"input",required:!0,name:"id",htmltype:"text"},{label:"Name",type:"input",name:"name",required:!0,htmltype:"text"},{label:"Tite",type:"input",required:!0,name:"title",htmltype:"text"},{label:"Path",type:"input",required:!0,name:"path",htmltype:"text"},{label:"Version",type:"input",name:"version",htmltype:"text"},{label:"Contact email",type:"input",name:"contact",htmltype:"email"},{label:"Author",type:"input",name:"author",htmltype:"text"},{label:"Website",type:"input",name:"website",htmltype:"text"},{label:"Copyright",type:"input",name:"copyright",htmltype:"text"},{label:"License",type:"input",name:"license",htmltype:"text"},{fields:[{fields:[],label:"Index page Id",type:"input",name:"indexPageId"},{fields:[{label:"Object name",type:"input",name:"objectName",htmltype:"text"}],label:"Objects",type:"array",options:{primitive:!0},name:"objects"},{fields:[{label:"File object name",type:"input",name:"fileObjectName",htmltype:"text"}],label:"File objects",type:"array",options:{primitive:!0},name:"file_objects"},{fields:[{label:"File name",type:"input",name:"File name",htmltype:"text"}],label:"Source files",type:"array",options:{primitive:!0},name:"source_code"},{fields:[{label:"List config object",type:"input",required:!0,name:"listconfigobject",htmltype:"text"},{label:"Form config object",type:"input",required:!0,name:"formconfigobject",htmltype:"text"},{label:"Menu config object",type:"input",required:!0,name:"menuconfigobject",htmltype:"text"},{label:"Page config object",type:"input",required:!0,name:"pageconfigobject",htmltype:"text"},{label:"Chart config object",type:"input",required:!0,name:"chartconfigobject",htmltype:"text"},{label:"Single item config object",type:"input",required:!0,name:"singleitemconfigobject",htmltype:"text"}],label:"Object map",type:"composite",options:{},name:"objectmap"}],label:"Settings",type:"composite",options:{},name:"settings"}],onsuccess:{type:"message",value:"Application has been saved"},owner:"5415b4b7d70af3e2078df1c1",modifytime:"2014-10-26 19:21:49.707748",action:"/service/cosmos.applications",_id:"544be3efedb05831be77e534",type:"form",createtime:"2014-10-26 18:18:16.677394"}},e.itemType=t.itemType,e.appPath=t.appPath,e.itemId=t.itemId,e.widget={},e.source={},e.clearError=function(){},e.processItem=function(t,o){e[t]=o||{},e.ready=!0},e.processError=function(e,t){$.notify("Error "+t+":"+e,"error")},e.processSourceFile=function(t){if(t&&"gridfile"===t.type){var o="/gridfs/cosmos.sourcefiles/"+t.file_id+"/";n.get(o,function(t){e.source.code=t},function(t,o){e.processError(t,o)})}},e.getItemByUrl=function(t,o){n.get(o,function(o){e.processItem(t,o),"sourcefiles"===t&&e.processSourceFile(o)},function(t,o){e.processError(t,o)})},e.getItem=function(t,o){if(e.appPath&&e.itemId){var o=e.getItemConfigName(e.itemType);a.getAppSettings(e.appPath,o,function(o){var i="/service/"+o+"/"+e.itemId+"/";"widget"!==e.itemType&&"interceptor"!==e.itemType&&"sourcefiles"!==e.itemType&&"appendpoint"!==e.itemType||(i=i+'?filter={"app_id":"'+e.app.id+'"}'),e.getItemByUrl(t,i)},function(t,o){e.processError(o,t)})}else e.ready=!0},e.getItemConfigName=function(e){return"widget"===e?"widgetobject":"list"===e?"listconfigobject":"menu"===e?"menuconfigobject":"chart"===e?"chartconfigobject":"singleitemview"===e?"singleitemconfigobject":"app"===e?"appconfigobject":"sourcefiles"===e?"sourcecolname":"interceptor"===e?"interceptorconigobject":"appendpoint"===e?"appendpointconigobject":void 0},e.saveItemWithUrl=function(t){e.clearError(),e.result=null,e.itemId?(t=t+e.itemId+"/",n.put(t,e[e.itemType],function(t){e.result=t,$.notify("Updated "+e.itemType,"success")},function(t,o){e.processError(t,o)})):("widget"!==e.itemType&&"interceptor"!==e.itemType&&"sourcefiles"!==e.itemType&&"appendpoint"!==e.itemType||(e[e.itemType].app_id=e.app.id),n.post(t,e[e.itemType],function(t){e.result=t,e.itemId=JSON.parse(t),$.notify("Saved "+e.itemType,"success")},function(t,o){e.processError(t,o)}))},e.saveCoreItem=function(){var t=e.getItemConfigName(e.itemType);a.getAppSettings(e.appPath,t,function(t){var o="/service/"+t+"/";e.saveItemWithUrl(o)},function(t,o){e.processError(o,t)})},e.saveSourceFile=function(){var t=e.sourcefiles,o=e.source.code;t&&"gridfile"===t.type&&"gridfile"===t.type?n.saveFile("cosmos.sourcefiles",o,"cosmos/source",t.filename,t.file_id,function(t){e.sourcefiles.file_id=t.file_id,e.saveCoreItem()},function(t,o){e.processError(t,o)}):e.saveCoreItem()},e.saveItem=function(){"sourcefiles"===e.itemType?e.saveSourceFile():e.saveCoreItem()},e.initApplication=function(){a.getApplication(e.appPath,function(t){var o=e.getItemConfigName(e.itemType);e.app=t,e.initForms(),e.getItem(e.itemType,o)},function(t,o){e.processError(o,t)})},e.init=function(){var t=e.getItemConfigName(e.itemType);if(e.list={columns:[]},e.menu={fields:[]},e.app={settings:{source_code:[],objects:[],objectmap:{},file_objects:[]}},e.singleitemview={columns:[]},e.sourcefiles={type:"gridfile"},e.chart={margin:{},columns:[]},e.interceptor={},e.appendpoint={},"app"===e.itemType){var t=e.getItemConfigName(e.itemType);e.initForms(),e.getItem(e.itemType,t)}else e.initApplication()}}]),directives.directive("field",["$compile",function(e){return{restrict:"E",scope:{item:"=",val:"="},controller:["$scope","$location","$routeParams","$uibModal","message","CosmosService","namedcolection","calculator","globalhashtable","cosmos.settings","cosmos.configNames","cosmos.utils","cosmos.settings",function(e,t,o,i,n,a,l,r,s,c,p,u,c){e.namedcolection=l,e.calculator=r,e.CosmosService=a,e.hashtable=s,e.routeParams=o,e.processError=function(e,t){},e.receiveServiceDataAs=function(t,o){if(o){var i=o.name,n=o.parse;i&&(n?e[i]=JSON.parse(t):e[i]=t)}},e.prepareObject=function(t,o){angular.forEach(t.fields,function(t,i){"composite"===t.type?(o[t.name]={},e.prepareObject(t,o[t.name])):"array"===t.type?(o[t.name]=[],o[t.name][0]={},e.prepareObject(t,o[t.name][0])):t.name&&(o[t.name]="")})},e.add_primitive_item=function(t){var o="";e.prepareObject(e.item,o),e.val.splice(t+1,0,o)},e.add_item=function(t){var o={};e.prepareObject(e.item,o),e.val||(e.val=[]),e.val.splice(t+1,0,o)},e.removeItem=function(t){e.val.splice(t,1)},e.getLookup=function(e,t){var o;return angular.forEach(e.options.lookups,function(e,i){e.ref===t&&(o=e)}),o},e.updateOptions=function(t){var o;if(o=e.item.options.saveValueOnly?e.getLookup(t,e.ref):e.getLookup(t,e.val.ref||e.ref),t.optionData[o.ref])e.optionData=t.optionData[o.ref];else{var i=o.url;a.get(i,function(i){e.optionData=i,t.optionData[o.ref]=i},function(t,o){e.processError(t,o)})}},e.getData=function(t,o,i,n,l){var r="";angular.forEach(t,function(e,t){r+=e.name+","});var s=n?"&filter="+n:"",p=c.getServiceRootUrl()+o+(i?"/"+i:"")+"/?columns="+r+s;a.get(p,function(t){e[l]=t},e.processError)},e.getConfiguration=function(t,i,n,l){e.appPath=o.appPath;var r=c.getConfigObjectName(t);c.getAppSettings(e.appPath,r,function(e){var t=c.getServiceRootUrl()+e+"/"+i+"/";a.get(t,function(e){n&&n(e)},function(e,t){l&&l(e,t)})},function(e,t){l&&l(t,e)})},e.getMenuConfiguration=function(){e.getConfiguration(p.MENU,e.item.value.menuId,function(t){e.data={},e.menuConfiguration=t},function(t,o){e.processError(o,t)})},e.getListDataBy=function(t,o,i){var n="";angular.forEach(t,function(e,t){n+=e.name+","});var l=i?"&filter="+JSON.stringify(i):"",r=c.getServiceRootUrl()+o+"/?columns="+n+l;a.get(r,function(t){e.data=t},e.processError)},e.getListDataFromConfig=function(t){for(var i=t.columns,n=t.objectName,a=JSON.parse(t.filter||"{}"),l=t.useQueryFilterParam?JSON.parse(o.filter||"{}"):{},r={},s=0;s<e.toolbarFilters.length;s++){var c=e.toolbarFilters[s];r[c.column]=c.firstOperand}var p=angular.extend({},a,l,r);Object.keys(p).length<1&&(p=null),e.getListDataBy(i,n,p)},e.getListConfiguration=function(){e.getConfiguration(p.LIST,e.item.value.listId,function(t){e.data={},e.listConfiguration=t,e.getListDataFromConfig(e.listConfiguration)},e.processError)},e.editListItem=function(e,t){if(t.editable&&t.itemeditor_id){i.open({templateUrl:"partials/formview.html",controller:"FormViewModalCtrl",size:"lg",backdrop:"static",resolve:{model:function(){return e},formId:function(){return t.itemeditor_id}}})}},e.showListItemDetails=function(e,t){if(t.allowDetails){i.open({templateUrl:"partials/show_json.html",controller:"ShowJsonDataCtrl",size:"lg",backdrop:"static",resolve:{model:function(){return e}}})}},e.getChartDataBy=function(t,o){var i="";angular.forEach(t,function(e,t){i+=e.name+","});var n=c.getServiceRootUrl()+o+"/?columns="+i;a.get(n,function(t){e.data=t},e.processError)},e.getChartDataFromConfig=function(t){var o=t.columns,i=t.objectName;e.getChartDataBy(o,i)},e.getChartConfiguration=function(){e.getConfiguration(p.CHART,e.item.value.chartId,function(t){e.data={},e.chartConfiguration=t,e.getChartDataFromConfig(e.chartConfiguration)},e.processError)},e.getFormConfiguration=function(){e.getConfiguration(p.FORM,e.item.value.formId,function(t){e.data={},e.form=t,e.val&&e.getFormData(e.form,e.val)},e.processError)},e.getFormData=function(t,o){if(o){var i=t.action+"/"+o+"/";a.get(i,function(t){jQuery.extend(t,e.data),e.data=t},function(t,o){e.processError(t,o)})}},e.processFormResult=function(o,i){if(o&&o.onsuccess)if("url"===o.onsuccess.type){var a=e.val||JSON.parse(i);window.location.href=o.onsuccess.value.replace("{{_id}}",a)}else"message"===o.onsuccess.type?(n.push({message:o.onsuccess.value,title:"Sucess",data:i}),t.path("/message")):"inlinemessage"===o.onsuccess.type&&(e.submitDone=!0)},e.onFormSubmit=function(){if(e.form.action){if(e.form.enableReCapcha){var t=grecaptcha.getResponse();if(!t||t.length<10)return void e.processError("Capcha not satisfied",400);e.data["g-recaptcha-response"]=t}if(e.val){var o=e.form.action+"/"+e.val+"/";a.put(o,e.data,function(t){e.processFormResult(e.form,t)},function(t,o){e.processError(t,o)})}else a.post(e.form.action,e.data,function(t){e.processFormResult(e.form,t)},function(t,o){e.processError(t,o)})}},e.validateBlockType=function(e){switch(e){case"h1":case"h2":case"h3":case"h4":case"h5":case"p":break;default:throw"HTML block not allowed"}},e.getTemplate=function(t){var o,i=t.type;switch(i){case"htmlblock":e.validateBlockType(t.blocktype),o="<"+t.blocktype+' ng-class="item.cssclass">{{item.value}}</'+t.blocktype+">";break;case"hyperlink":o='<a ng-class="item.cssclass" href="'+t.value.href+'">'+t.value.text+"</a>";break;case"image":o='<img ng-src="{{item.src}}" />';break;case"twocolumn":o='   <div class="row">       <div ng-repeat="field in item.leftcolumn" class="col-md-6">           <field item="field"></field>       </div>       <div ng-repeat="field in item.rightcolumn" class="col-md-6">           <field item="field"></field>       </div>   </div>';break;case"threecolumn":o='   <div class="row">       <div ng-repeat="field in item.leftcolumn" class="col-xs-4">           <field item="field"></field>       </div>       <div ng-repeat="field in item.midcolumn" class="col-xs-4">           <field item="field"></field>       </div>       <div ng-repeat="field in item.rightcolumn" class="col-xs-4">           <field item="field"></field>       </div>   </div>';break;case"menu":o="sidebar"===t.navtype?'<ul class="well nav nav-pills nav-stacked">   <li ng-repeat="field in item.fields">       <field item="field"></field>   </li></ul>':'   <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">                                                   <div class="container">                                                     <div class="navbar-header">                                                       <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">                                                         <span class="sr-only">{{item.brandtitle}}</span>                                                         <span class="icon-bar"></span>                                                         <span class="icon-bar"></span>                                                         <span class="icon-bar"></span>                                                       </button>                                                       <a class="navbar-brand" href="{{item.brandhref}}">{{item.brandtitle}}</a>                                                     </div>                                                     <div id="navbar" class="navbar-collapse collapse">                                                       <ul class="nav navbar-nav">                                                         <li ng-repeat="field in item.fields">                                                                <field item="field"></field>                                                         </li>                                                       </ul>                                                     </div>                                                   </div>                                                 </nav>';break;case"menuitem":o='   <a href="{{item.value.href}}">{{item.value.label}}</a>';break;case"menuref":o='<field ng-if="menuConfiguration" item="menuConfiguration"></field>';break;case"compositeblock":o='<div ng-repeat="field in item.fields">    <field item="field"></field></div>';break;case"widgethost":o="<div ng-include=\"'"+t.value+'\'" class="'+t.cssclass+'"></div>';break;case"inlinewidget":o=t.value.widgettext||t.value;break;
case"input":case"text":var n=t.minlength?' ng-minlength="item.minlength" ':"",a=t.maxlength?' ng-maxlength="item.maxlength" ':"",l=t.required?" required ":"",r=t.pattern?' ng-pattern="item.pattern "':"",s=t.placeholder?' placeholder="'+t.placeholder+'" ':"",c=t.title?' title="'+t.title+'" ':"",p=n+a+r+l+s+c;o='<label>{{item.label}}<span ng-if="item.required">&nbsp;*&nbsp;</span></label><input class="form-control" type="{{item.htmltype || \'text\'}}" ng-model="val"'+p+"  />";break;case"filectrl":var o='<filectrl label="item.label" required="item.required" object-name="item.objectName" val="val"/>';break;case"static":o='<span><label>{{item.label}}</label><input type="text" ng-model="val" readonly="readonly"/></span>';break;case"textarea":o='<span><label>{{item.label}}<span ng-if="item.required">&nbsp;*&nbsp;</span></label><textarea '+(t.required?"required":"")+' ng-model="val" /></span>';break;case"codeeditor":o='<span><label>{{item.label}}<span ng-if="item.required">&nbsp;*&nbsp;</span></label><div '+(t.required?"required":"")+' ui-ace ng-model="val"></div></span>';break;case"checkbox":o='<input type="checkbox" ng-model="val"> <label class="control-label">{{item.label}}</label>';break;case"select":o='<label class="control-label">{{item.label}}</label><select ng-model="val" ng-options="choice.value as choice.label for choice in item.options.choices">   <option ng-if="item.nullable === true"> --- Select ---</option></select>';break;case"radiogroup":o='<label class="control-label">{{item.label}}</label><div class="composite" ng-repeat="choice in item.options.choices">   <input type="radio" ng-value="choice.value" ng-model="$parent.val">   <label class="control-label">{{choice.label}}</label></div>';break;case"lookup":o=t.options.saveValueOnly?'<label class="control-label">{{item.label}}</label><select class="form-control" ng-if="!item.options.hideRefType" ng-model="ref" ng-options="lookup.ref as lookup.lookupname for lookup in item.options.lookups"ng-change="updateOptions(item)">'+(t.options.refRequired?"":"   <option>---</option>")+'</select><select class="form-control" ng-model="val">'+(t.required?"":"   <option>---</option>")+'    <option ng-value="option[getLookup(item, ref).value]"    ng-selected="option[getLookup(item, ref).value] === val"        ng-repeat="option in optionData">{{option[getLookup(item, ref).label]}}</option></select>':'<label class="control-label">{{item.label}}</label><select class="form-control" ng-model="val.ref" ng-options="lookup.ref as lookup.lookupname for lookup in item.options.lookups"ng-change="updateOptions(item)">'+(t.options.refRequired?"":"   <option>---</option>")+'</select><select class="form-control" ng-model="val.data">'+(t.required?"":"   <option>---</option>")+'    <option ng-value="option[getLookup(item, val.ref).value]"    ng-selected="option[getLookup(item, val.ref).value] === val.data"        ng-repeat="option in optionData">{{option[getLookup(item, val.ref).label]}}</option></select>';break;case"pageref":o='<page pageid="item.pageId"></page>';break;case"formref":o='<div ng-show="submitDone">{{form.onsuccess.value}}</div><form role="form" class="form-horizontal" name="form'+t.value.formId+'" ng-hide="submitDone" novalidate>    <div>        <h1>{{form.title}}</h1>    </div>    <ul>        <li ng-repeat="field in form.fields">            <field item="field" val="data[field.name]"></field>        </li>        <li ng-if="form.enableReCapcha">           <div id="g_recapcha_'+u.getNextValue()+'" class="g-recaptcha" data-sitekey="'+u.getCapchaSiteKey()+'"></div>        </li>    </ul>    <button ng-disabled="!(form'+t.value.formId+'.$valid)" class="btn btn-primary" ng-click="onFormSubmit()">Submit</button></form>';break;case"cssref":o='<link data-ng-href="{{item.href}}" rel="stylesheet" />';break;case"jsref":o='<script data-ng-src="item.src" />';break;case"extjsref":o='<script src="'+t.src+'" />';break;case"list":case"listref":o='<div ng-if="listConfiguration.allowUserFilter">   <filter columns="listConfiguration.columns" filters="toolbarFilters"></filter>   <button class="glyphicon glyphicon-refresh" ng-click="getListDataFromConfig(listConfiguration)"></button></div><div ng-if="listConfiguration !== undefined"><div ng-include="listConfiguration.widgetName" /></div></div>';break;case"chartref":o='<div ng-if="chartConfiguration !== undefined">   <div ng-class="chartConfiguration.chartHolderClass">       <div id="chart'+t.value.chartId+'" ng-class="chartConfiguration.chartClass"></div>   </div></div>';break;case"form":o='<div>   <label ng-if="item.showTitle" >{{item.title}}</label></div><ul>   <li ng-repeat="field in item.fields">       <field item="field" val="val[field.name]"></field>   </li></ul>';break;case"composite":o='<div>   <label>{{item.label}}</label></div><ul>   <li ng-repeat="field in item.fields">       <field item="field" val="val[field.name]"></field>   </li></ul>';break;case"array":o=t.options&&t.options.primitive?'<div>   <label>{{item.label}}</label>   <button label="add" class="glyphicon glyphicon-plus" ng-click="add_primitive_item(-1)"></button></div><ul>   <li ng-repeat="v in val track by $index">       <field val="val[$index]" item="item.fields[0]"></field>       <button title="remove" class="glyphicon glyphicon-minus" ng-click="removeItem($index)"></button>       <button label="add" class="glyphicon glyphicon-plus"" ng-click="add_primitive_item($index)"></button>   </li></ul>':'<div>   <label>{{item.label}}</label>   <button ng-click="add_item(-1)">+</button></div><ul>   <li ng-repeat="d in val">       <field val="d[field.name]" item="field" ng-repeat="field in item.fields"></field>       <button ng-click="removeItem($index)">-</button>       <button ng-click="add_item($index)">+</button>   </li></ul>';break;case"condition":o='<div>                                     <label class="control-label">{{field.label}}</label>                                     <ul>                                         <li ng-if="'+t.expression+'">                                             <ul>                                                 <li ng-repeat="field in item.fields">                                                     <field item="field" val="val[field.name]"></field>                                                 </li>                                             </ul>                                         </li>                                         <li ng-if="!('+t.expression+')">                                             <ul>                                                 <li ng-repeat="field in item.elsefields">                                                     <field item="field" val="val[field.name]"></field>                                                 </li>                                             </ul>                                         </li>                                     </ul>                                 </div>';break;case"itemview":o="<div ng-include=\"'"+t.value.widget+'\'" class="'+t.cssclass+'"></div>';break;default:o=null}return o}}],link:function(t,o,i){console.log("Creating field "+t.item.type);var n=t.getTemplate(t.item);if(n){if("static"===t.item.type&&(t.val=t.item.options.value),"array"===t.item.type&&(!t.val||t.val.length<1)&&(t.val=[]),"composite"!==t.item.type&&"form"!==t.item.type&&"condition"!==t.item.type||t.val||(t.val={}),"lookup"===t.item.type&&(t.item.optionData={},t.val||t.item.options.saveValueOnly?t.val&&t.val.ref||t.item.options.saveValueOnly&&t.ref?t.updateOptions(t.item):t.item.options.saveValueOnly&&t.item.options.hideRefType&&(t.ref=t.item.options.lookups[0].ref,t.updateOptions(t.item)):t.val={ref:null,data:null}),"list"===t.item.type&&(t.data={},t.listConfiguration=t.item.config,t.getListDataFromConfig(t.listConfiguration)),"listref"===t.item.type&&(t.toolbarFilters=[],t.getListConfiguration()),"chartref"===t.item.type&&(t.$watch("data",function(){if(t.chartConfiguration&&t.data){var e="#chart"+t.item.value.chartId;"bar"===t.chartConfiguration.chartType?drawBarChart(e,t.chartConfiguration.config,t.data):"line"===t.chartConfiguration.chartType?drawLineChart(e,t.chartConfiguration.config,t.data):"pie"===t.chartConfiguration.chartType&&drawPieChart(e,t.chartConfiguration.config,t.data)}}),t.getChartConfiguration()),"formref"===t.item.type&&t.getFormConfiguration(),"cssref"===t.item.type){var a=angular.element(document.getElementsByTagName("head")[0]),l=angular.element(n);a.append(l),e(l)(t),n="<!-- cssref has been placed into header  -->"}if("jsref"===t.item.type||"extjsref"===t.item.type){var a=angular.element(document.getElementsByTagName("head")[0]),l=angular.element(n);a.append(l),e(l)(t),n="<!-- jsref has been placed into header  -->"}"menuref"===t.item.type&&(t.menuConfiguration={brandtitle:"",type:"menu",fields:[]},t.getMenuConfiguration());var l=angular.element(n);o.replaceWith(l),e(l)(t)}}}}]),directives.directive("filter",function(e){return{restrict:"E",scope:{columns:"=",filters:"=?"},controller:["$scope","$location","$routeParams","message","CosmosService","cosmos.settings",function(e,t,o,i,n,a){e.routeParams=o,e.operators=[{title:"Equals",name:"eq"}],e.addFilter=function(){e.filters.push({column:e.columnName,op:e.operator,firstOperand:e.firstOperand})},e.removeFilter=function(e,t){e.splice(t,1)},e.requireSecondOperand=function(e){return"between"===e},e.getTemplate=function(){var e='<div class="show-hide-filter"></div><div class="row">   <div class="col-lg-2">       <select class="form-control" ng-model="columnName" ng-options="column.name as column.title for column in columns" />   </div>   <div class="col-lg-2">       <select class="form-control" ng-model="operator" ng-options="operator.name as operator.title for operator in operators" />   </div>   <div class="col-lg-3">       <input class="form-control" ng-model="firstOperand" />   </div>   <div ng-if="requireSecondOperand(operator)" class="col-lg-3">       <input class="form-control" ng-model="secondOperand" />   </div>   <div class="col-lg-1">       <button ng-click="addFilter()" class="glyphicon glyphicon-plus"></button>   </div></div><div class="row">       <ul>           <li ng-repeat="filter in filters">               {{filter.column}} {{filter.op}} {{filter.firstOperand}}               <span ng-if="requireSecondOperand(filter.op)"> and {{filter.secondOperand}}</span>               <button class="glyphicon glyphicon-remove" ng-click="removeFilter(filters, $index)"></button>           </li>       </ul>   </div></div>';return e}}],link:function(t,o,i){console.log("Creating filter element"),t.element=o,t.filters||(t.filters=[]);var n=t.getTemplate(),a=angular.element(n);o.replaceWith(a),e(a)(t)}}}),services.factory("CosmosService",["$http",function(e){return{get:function(t,o,i){e.get(t).success(function(e){var t=e;e&&e._cosmos_service_array_result_&&(t=JSON.parse(e._d)),o&&o(t)}).error(function(e,t){i&&i(e,t)})},search:function(t,o,i,n){e.get(t,o).success(function(e){var t=e;e&&e._cosmos_service_array_result_&&(t=JSON.parse(e._d)),i&&i(t)}).error(function(e,t){n&&n(e,t)})},post:function(t,o,i,n){e.post(t,o).success(function(e){var t=e;e&&e._cosmos_service_array_result_&&(t=JSON.parse(e._d)),i&&i(t)}).error(function(e,t){n&&n(e,t)})},postWithArgs:function(t,o,i,n,a,l){e.post(t,o).success(function(e){var t=e;e&&e._cosmos_service_array_result_&&(t=JSON.parse(e._d)),i&&i(t,n)}).error(function(e,t){a&&a(e,t,l)})},put:function(t,o,i,n){e.put(t,o).success(function(e){i&&i(e)}).error(function(e,t){n&&n(e,t)})},"delete":function(t,o,i){e["delete"](t).success(function(e){o&&o(e)}).error(function(e,t){i&&i(e,t)})},saveFile:function(e,t,o,i,n,a,l){var r=new FormData,s=new Blob([t],{type:o});r.append("uploadedfile",s,i);var c=new XMLHttpRequest,p="/gridfs/"+e+"/"+(n?n+"/":"");c.onload=function(e){if(200==c.status){if(a){var t=JSON.parse(c.response);t&&t._cosmos_service_array_result_&&(t=JSON.parse(t._d),t&&t.length>0&&(t=t[0])),a(t)}}else l&&l(c.status,c.responseText)};var u=n?"PUT":"POST";c.open(u,p),c.send(r)}}}]),services.factory("cosmos.cachedloader",["CosmosService",function(e){return{store:{},clearCache:function(e){delete this.store[e]},get:function(t,o,i,n,a){if(!a)var l=this.store[t];l?i&&i(l):e.get(o,function(e){this.store[t]=e,i&&i(e)}.bind(this),function(e,t){n&&n(e,t)}.bind(this))},getFromCache:function(e){return this.store[e]}}}]);var getAppSettingsByAppImpl=function(e,t){if(e&&e.settings&&e.settings.objectmap&&e.settings.objectmap[t]){var o=e.settings.objectmap[t];return o}};services.factory("cosmos.settings",["CosmosService","cosmos.cachedloader","cosmos.configNames",function(e,t,o){return{getServiceRootUrl:function(){return"/ios/service/"},getAppSettings:function(e,o,i,n){if("appconfigobject"===o)return i?void i("cosmos.applications"):"cosmos.applications";if("widgetobject"===o)return i?void i("cosmos.widgets"):"cosmos.widgets";if("sourcecolname"===o)return i?void i("cosmos.sourcemodules"):"cosmos.sourcemodules";if("interceptorconigobject"===o)return i?void i("cosmos.interceptors"):"cosmos.interceptors";if("appendpointconigobject"===o)return i?void i("cosmos.appendpoints"):"cosmos.appendpoints";var a="Application."+e,l=this.getServiceRootUrl()+'cosmos.applications/?filter={"path":"'+e+'"}';t.get(a,l,function(t){var a;t&&1==t.length&&(a=t[0]);var l=getAppSettingsByAppImpl(a,o);l?i&&i(l):n&&n("Settings not found for the given path. Path = "+e+" Settings name= "+o,404)},function(e,t){n&&n(e,t)})},getConfigObjectName:function(e){return e===o.MENU?"menuconfigobject":e===o.LIST?"listconfigobject":e===o.CHART?"chartconfigobject":e===o.FORM?"formconfigobject":e===o.SOURCEFILES?"sourcecolname":"interceptor"===e?"interceptorconigobject":"appendpoint"===e?"appendpointconigobject":void 0},getAppSettingsByApp:function(e,t){return"appconfigobject"===t?"cosmos.applications":"widgetobject"===t?"cosmos.widgets":"sourcecolname"===t?"cosmos.sourcemodules":"interceptorconigobject"===t?"cosmos.interceptors":"appendpointconigobject"===t?"cosmos.appendpoints":getAppSettingsByAppImpl(e,t)},getApplication:function(e,o,i){var n="Application."+e,a=this.getServiceRootUrl()+'cosmos.applications/?filter={"path":"'+e+'"}';t.get(n,a,function(t){if(t&&1==t.length){var n=t[0];o(n)}else i("Application not found for the given path. Path = "+e,404)},function(e,t){i(e,t)})},clearCache:function(e){t.clearCache(e)},getAllAppCacheName:function(){return"Application._Cosmos_All_Applications_"},getApplications:function(e,o){var i="Application._Cosmos_All_Applications_",n=this.getServiceRootUrl()+"cosmos.applications/";t.get(i,n,function(t){e(t)},function(e,t){o(e,t)})},getGlobalSettings:function(e,o){var i="Settings._Cosmos_Global_Settings_",n=this.getServiceRootUrl()+"cosmos.globalsettings/";t.get(i,n,function(t){t&&1==t.length?e&&e(t[0]):o&&o(404,"Global settings not found or more than one found. Count = "+t.length)},function(e,t){o&&o(e,t)})},initSettings:function(e,t){this.getGlobalSettings(e,t)}}}]),services.constant("cosmos.configNames",{MENU:"menu",FORM:"form",PAGE:"page",LIST:"list",CHART:"chart",WIDGET:"widget",APP:"app",SINGLE_OBJECT:"singleobject",SOURCEFILES:"sourcefiles"}),services.factory("cosmos.utils",["CosmosService","cosmos.cachedloader","cosmos.settings",function(e,t,o){return{siteWideCounter:0,setAppAsDefault:function(t,o,i){if(t&&t.id){var n="/service/cosmos.globalsettings/";e.get(n,function(a){if(a&&a.length>0){var l=a[0];n=n+l._id+"/";var r={defaultappid:t.id};e.put(n,r,o,i)}else{var r={defaultappid:t.id};e.post(n,r,o,i)}},i)}else i&&i(404,"Application not found")},setPageAsDefault:function(t,o,i,n){if(t&&t._id){var a="/service/cosmos.applications/"+t._id;e.get(a,function(t){if(t){var l=t;l.settings.indexPageId=o._id;var r={settings:l.settings};e.put(a,r,i,n)}else n(404,"Application not found")},n)}else n&&n(404,"Application not found")},getAllPages:function(e,o,i){var n="Page._Cosmos_All_Pages_",a="/service/"+e.settings.objectmap.pageconfigobject+"/";t.get(n,a,function(e){o(e)},function(e,t){i(e,t)})},getNextValue:function(e){return e?e+1:(this.siteWideCounter+=1,this.siteWideCounter)},getCapchaSiteKey:function(){var e=t.getFromCache("Settings._Cosmos_Global_Settings_");return e?e[0].recapchasitekey:void 0}}}]);